#include "out.h"



int _init(EVP_PKEY_CTX *ctx)

{
  int iVar1;
  
  iVar1 = __gmon_start__();
  return iVar1;
}



void FUN_00101020(void)

{
  (*(code *)(undefined *)0x0)();
  return;
}



void __cxa_finalize(void)

{
  __cxa_finalize();
  return;
}



void FUN_00101250(int param_1,int param_2,int param_3)

{
  socket(param_1,param_2,param_3);
  return;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

void free(void *__ptr)

{
  free(__ptr);
  return;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

char * strncpy(char *__dest,char *__src,size_t __n)

{
  char *pcVar1;
  
  pcVar1 = strncpy(__dest,__src,__n);
  return pcVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

char * strcpy(char *__dest,char *__src)

{
  char *pcVar1;
  
  pcVar1 = strcpy(__dest,__src);
  return pcVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

int puts(char *__s)

{
  int iVar1;
  
  iVar1 = puts(__s);
  return iVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

size_t fread(void *__ptr,size_t __size,size_t __n,FILE *__stream)

{
  size_t sVar1;
  
  sVar1 = fread(__ptr,__size,__n,__stream);
  return sVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

int setsockopt(int __fd,int __level,int __optname,void *__optval,socklen_t __optlen)

{
  int iVar1;
  
  iVar1 = setsockopt(__fd,__level,__optname,__optval,__optlen);
  return iVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

ssize_t write(int __fd,void *__buf,size_t __n)

{
  ssize_t sVar1;
  
  sVar1 = write(__fd,__buf,__n);
  return sVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

int fclose(FILE *__stream)

{
  int iVar1;
  
  iVar1 = fclose(__stream);
  return iVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

size_t strlen(char *__s)

{
  size_t sVar1;
  
  sVar1 = strlen(__s);
  return sVar1;
}



void __stack_chk_fail(void)

{
                    // WARNING: Subroutine does not return
  __stack_chk_fail();
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

uint16_t htons(uint16_t __hostshort)

{
  uint16_t uVar1;
  
  uVar1 = htons(__hostshort);
  return uVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

char * strchr(char *__s,int __c)

{
  char *pcVar1;
  
  pcVar1 = strchr(__s,__c);
  return pcVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

int printf(char *__format,...)

{
  int iVar1;
  
  iVar1 = printf(__format);
  return iVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

int fputs(char *__s,FILE *__stream)

{
  int iVar1;
  
  iVar1 = fputs(__s,__stream);
  return iVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

char * strncat(char *__dest,char *__src,size_t __n)

{
  char *pcVar1;
  
  pcVar1 = strncat(__dest,__src,__n);
  return pcVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

size_t strcspn(char *__s,char *__reject)

{
  size_t sVar1;
  
  sVar1 = strcspn(__s,__reject);
  return sVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

ssize_t read(int __fd,void *__buf,size_t __nbytes)

{
  ssize_t sVar1;
  
  sVar1 = read(__fd,__buf,__nbytes);
  return sVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

void * calloc(size_t __nmemb,size_t __size)

{
  void *pvVar1;
  
  pvVar1 = calloc(__nmemb,__size);
  return pvVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

int strcmp(char *__s1,char *__s2)

{
  int iVar1;
  
  iVar1 = strcmp(__s1,__s2);
  return iVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

int fprintf(FILE *__stream,char *__format,...)

{
  int iVar1;
  
  iVar1 = fprintf(__stream,__format);
  return iVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

long ftell(FILE *__stream)

{
  long lVar1;
  
  lVar1 = ftell(__stream);
  return lVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

void * malloc(size_t __size)

{
  void *pvVar1;
  
  pvVar1 = malloc(__size);
  return pvVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

int fflush(FILE *__stream)

{
  int iVar1;
  
  iVar1 = fflush(__stream);
  return iVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

int listen(int __fd,int __n)

{
  int iVar1;
  
  iVar1 = listen(__fd,__n);
  return iVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

int fseek(FILE *__stream,long __off,int __whence)

{
  int iVar1;
  
  iVar1 = fseek(__stream,__off,__whence);
  return iVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

int bind(int __fd,sockaddr *__addr,socklen_t __len)

{
  int iVar1;
  
  iVar1 = bind(__fd,__addr,__len);
  return iVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

FILE * fopen(char *__filename,char *__modes)

{
  FILE *pFVar1;
  
  pFVar1 = fopen(__filename,__modes);
  return pFVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

void perror(char *__s)

{
  perror(__s);
  return;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

int accept(int __fd,sockaddr *__addr,socklen_t *__addr_len)

{
  int iVar1;
  
  iVar1 = accept(__fd,__addr,__addr_len);
  return iVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

__ssize_t getline(char **__lineptr,size_t *__n,FILE *__stream)

{
  __ssize_t _Var1;
  
  _Var1 = getline(__lineptr,__n,__stream);
  return _Var1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

void exit(int __status)

{
                    // WARNING: Subroutine does not return
  exit(__status);
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

size_t fwrite(void *__ptr,size_t __size,size_t __n,FILE *__s)

{
  size_t sVar1;
  
  sVar1 = fwrite(__ptr,__size,__n,__s);
  return sVar1;
}



// WARNING: Unknown calling convention -- yet parameter storage is locked

char * strstr(char *__haystack,char *__needle)

{
  char *pcVar1;
  
  pcVar1 = strstr(__haystack,__needle);
  return pcVar1;
}



void processEntry _start(undefined8 param_1,undefined8 param_2)

{
  undefined auStack_8 [8];
  
  __libc_start_main(main,param_2,&stack0x00000008,0,0,param_1,auStack_8);
  do {
                    // WARNING: Do nothing block with infinite loop
  } while( true );
}



// WARNING: Removing unreachable block (ram,0x001014b3)
// WARNING: Removing unreachable block (ram,0x001014bf)

void deregister_tm_clones(void)

{
  return;
}



// WARNING: Removing unreachable block (ram,0x001014f4)
// WARNING: Removing unreachable block (ram,0x00101500)

void register_tm_clones(void)

{
  return;
}



void __do_global_dtors_aux(void)

{
  if (completed_0 != '\0') {
    return;
  }
  __cxa_finalize(__dso_handle);
  deregister_tm_clones();
  completed_0 = 1;
  return;
}



void frame_dummy(void)

{
  register_tm_clones();
  return;
}



int setup_socket(void)

{
  int iVar1;
  long in_FS_OFFSET;
  undefined4 local_34;
  undefined4 local_30;
  int local_2c;
  sockaddr local_28;
  long local_10;
  
  local_10 = *(long *)(in_FS_OFFSET + 0x28);
  local_34 = 1;
  local_30 = 0x10;
  local_2c = FUN_00101250(2,1,0);
  if (local_2c == 0) {
    perror("socket failed");
                    // WARNING: Subroutine does not return
    exit(1);
  }
  iVar1 = setsockopt(local_2c,1,0xf,&local_34,4);
  if (iVar1 != 0) {
    perror("setsockopt");
                    // WARNING: Subroutine does not return
    exit(1);
  }
  local_28.sa_family = 2;
  local_28.sa_data[2] = '\0';
  local_28.sa_data[3] = '\0';
  local_28.sa_data[4] = '\0';
  local_28.sa_data[5] = '\0';
  local_28.sa_data._0_2_ = htons(0x8ae);
  iVar1 = bind(local_2c,&local_28,0x10);
  if (iVar1 < 0) {
    perror("bind failed");
                    // WARNING: Subroutine does not return
    exit(1);
  }
  iVar1 = listen(local_2c,3);
  if (iVar1 < 0) {
    perror("listen");
                    // WARNING: Subroutine does not return
    exit(1);
  }
  if (local_10 != *(long *)(in_FS_OFFSET + 0x28)) {
                    // WARNING: Subroutine does not return
    __stack_chk_fail();
  }
  return local_2c;
}



char * command(char *param_1,char *param_2)

{
  char *__dest;
  void *pvVar1;
  
  __dest = (char *)malloc(0x10);
  pvVar1 = malloc(0x46);
  *(void **)(__dest + 8) = pvVar1;
  strncpy(__dest,param_1,8);
  strncpy(*(char **)(__dest + 8),param_2,0x46);
  return __dest;
}



void free_command(void *param_1)

{
  if (param_1 != (void *)0x0) {
    free(*(void **)((long)param_1 + 8));
    free(param_1);
  }
  return;
}



void print_command(long param_1)

{
  if (param_1 == 0) {
    puts("Invalid Command structure pointer (NULL).");
  }
  else {
    printf("Method: %s\n",param_1);
    printf("Argument: %s\n",*(undefined8 *)(param_1 + 8));
  }
  return;
}



char * command_from_string(char *param_1)

{
  char *__dest;
  void *pvVar1;
  char *pcVar2;
  size_t sVar3;
  long in_FS_OFFSET;
  int local_7c;
  char local_60 [7];
  undefined local_59;
  undefined8 local_58;
  undefined8 local_50;
  undefined8 local_48;
  undefined8 local_40;
  undefined8 local_38;
  undefined8 local_30;
  undefined8 local_28;
  undefined6 local_20;
  undefined2 uStack_1a;
  undefined5 uStack_18;
  undefined local_13;
  long local_10;
  
  local_10 = *(long *)(in_FS_OFFSET + 0x28);
  __dest = (char *)calloc(1,0x10);
  pvVar1 = malloc(0x46);
  *(void **)(__dest + 8) = pvVar1;
  pcVar2 = strchr(param_1,0x20);
  local_58 = 0;
  local_50 = 0;
  local_48 = 0;
  local_40 = 0;
  local_38 = 0;
  local_30 = 0;
  local_28 = 0;
  local_20 = 0;
  uStack_1a = 0;
  uStack_18 = 0;
  local_13 = 0;
  if (pcVar2 == (char *)0x0) {
    strncpy(local_60,param_1,7);
    local_59 = 0;
    strcpy(__dest,local_60);
  }
  else {
    local_7c = (int)pcVar2 - (int)param_1;
    if (7 < local_7c) {
      local_7c = 7;
    }
    strncpy(local_60,param_1,(long)local_7c);
    local_60[local_7c] = '\0';
    strncpy((char *)&local_58,pcVar2 + 1,0x45);
    local_13 = 0;
    sVar3 = strlen((char *)&local_58);
    printf("DEBUG command arg len %d\n",sVar3);
    strcpy(__dest,local_60);
    strcpy(*(char **)(__dest + 8),(char *)&local_58);
  }
  if (local_10 != *(long *)(in_FS_OFFSET + 0x28)) {
                    // WARNING: Subroutine does not return
    __stack_chk_fail();
  }
  return __dest;
}



void debug_msg(char *param_1)

{
  FILE *__stream;
  size_t __n;
  
  __stream = fopen("debug.log","a");
  if (__stream == (FILE *)0x0) {
    perror("Failed to open log file");
  }
  else {
    fprintf(__stream,param_1);
    fclose(__stream);
    __n = strlen(param_1);
    write(0x106130,param_1,__n);
  }
  return;
}



undefined8 put(char *param_1,int param_2)

{
  int iVar1;
  size_t sVar2;
  FILE *__stream;
  char *__s;
  undefined8 uVar3;
  
  sVar2 = strlen(param_1);
  write(param_2,param_1,sVar2);
  write(param_2,&DAT_001030b8,2);
  sVar2 = strlen(*(char **)(param_1 + 8));
  write(param_2,*(void **)(param_1 + 8),sVar2);
  __stream = fopen(*(char **)(param_1 + 8),"w");
  __s = (char *)malloc(0x14);
  if (__stream == (FILE *)0x0) {
    perror("Failed to open file");
    uVar3 = 1;
  }
  else {
    write(param_2,"\ntext> ",6);
    read(param_2,__s,0x14);
    iVar1 = fputs(__s,__stream);
    if (iVar1 == -1) {
      perror("Failed to write to file");
      fclose(__stream);
      uVar3 = 0;
    }
    else {
      fclose(__stream);
      uVar3 = 1;
    }
  }
  return uVar3;
}



undefined8 get(char *param_1,int param_2)

{
  size_t sVar1;
  void *pvVar2;
  char *pcVar3;
  long in_FS_OFFSET;
  uint local_44;
  char *local_40;
  size_t local_38;
  long local_30;
  void *local_28;
  FILE *local_20;
  size_t local_18;
  long local_10;
  
  local_10 = *(long *)(in_FS_OFFSET + 0x28);
  sVar1 = strlen(param_1);
  write(param_2,param_1,sVar1);
  write(param_2,&DAT_001030b8,2);
  sVar1 = strlen(*(char **)(param_1 + 8));
  write(param_2,*(void **)(param_1 + 8),sVar1);
  local_28 = malloc(0x30);
  pvVar2 = malloc(1000);
  *(void **)((long)local_28 + 0x28) = pvVar2;
  sVar1 = strlen(*(char **)(param_1 + 8));
  printf("%d\n",sVar1);
  printf("1: name: %p content: %p\n",local_28,*(undefined8 *)((long)local_28 + 0x28));
  for (local_44 = 0; *(char *)((long)(int)local_44 + *(long *)(param_1 + 8)) != '\0';
      local_44 = local_44 + 1) {
    printf("%d\n",(ulong)local_44);
    *(undefined *)((long)local_28 + (long)(int)local_44) =
         *(undefined *)((long)(int)local_44 + *(long *)(param_1 + 8));
  }
  printf("2: name: %p content: %p\n",local_28,*(undefined8 *)((long)local_28 + 0x28));
  printf("DEBUG fs file_name: %s\n",local_28);
  printf("DEBUG cmd arg: %s\n",*(undefined8 *)(param_1 + 8));
  local_20 = fopen(*(char **)(param_1 + 8),"r");
  if (local_20 == (FILE *)0x0) {
    perror("Error opening file");
  }
  else {
    local_40 = (char *)0x0;
    local_38 = 0;
    local_30 = 0;
    write(param_2,"\n====================\n",0x16);
    while( true ) {
      local_18 = getline(&local_40,&local_38,local_20);
      if (local_18 == 0xffffffffffffffff) break;
      pcVar3 = strstr(local_40,"SK-CERT");
      if (pcVar3 == (char *)0x0) {
        sVar1 = strlen(local_40);
        write(param_2,local_40,sVar1);
      }
      if (999 < local_30 + local_18) {
        fwrite("Warning: file content exceeds buffer size.\n",1,0x2b,stderr);
        break;
      }
      strncat(*(char **)((long)local_28 + 0x28),local_40,local_18);
      local_30 = local_30 + local_18;
    }
    write(param_2,"\n====================\n",0x16);
    free(local_40);
    fclose(local_20);
  }
  if (local_10 != *(long *)(in_FS_OFFSET + 0x28)) {
                    // WARNING: Subroutine does not return
    __stack_chk_fail();
  }
  return 1;
}



void encode_flag(void)

{
  int iVar1;
  int iVar2;
  byte *pbVar3;
  FILE *pFVar4;
  size_t __size;
  char *__s;
  long in_FS_OFFSET;
  int local_6c;
  int local_68;
  int local_64;
  int local_60;
  byte *local_58;
  byte local_17 [7];
  long local_10;
  
  local_10 = *(long *)(in_FS_OFFSET + 0x28);
  pFVar4 = fopen("flag.txt","rb");
  if (pFVar4 == (FILE *)0x0) {
    perror("Failed to open input file");
  }
  else {
    fseek(pFVar4,0,2);
    __size = ftell(pFVar4);
    fseek(pFVar4,0,0);
    local_58 = (byte *)malloc(__size);
    if (local_58 == (byte *)0x0) {
      perror("Memory allocation failed");
      fclose(pFVar4);
    }
    else {
      fread(local_58,1,__size,pFVar4);
      fclose(pFVar4);
      __s = (char *)malloc((long)((int)((long)(__size + 2) / 3) * 4 + 1));
      if (__s == (char *)0x0) {
        perror("Memory allocation failed");
        free(local_58);
      }
      else {
        local_6c = 0;
        local_64 = 0;
        local_60 = (int)__size;
        while (iVar2 = local_60 + -1, local_60 != 0) {
          pbVar3 = local_58 + 1;
          iVar1 = local_6c + 1;
          local_17[local_6c] = *local_58;
          local_6c = iVar1;
          local_60 = iVar2;
          local_58 = pbVar3;
          if (iVar1 == 3) {
            local_17[3] = local_17[0] >> 2;
            local_17[4] = (local_17[1] >> 4) + (char)((local_17[0] & 3) << 4);
            local_17[5] = (local_17[2] >> 6) + (char)((local_17[1] & 0xf) << 2);
            local_17[6] = local_17[2] & 0x3f;
            for (local_6c = 0; local_6c < 4; local_6c = local_6c + 1) {
              __s[local_64] =
                   "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"
                   [local_17[(long)local_6c + 3]];
              local_64 = local_64 + 1;
            }
            local_6c = 0;
          }
        }
        if (local_6c != 0) {
          for (local_68 = local_6c; local_68 < 3; local_68 = local_68 + 1) {
            local_17[local_68] = 0;
          }
          local_17[3] = local_17[0] >> 2;
          local_17[4] = (local_17[1] >> 4) + (char)((local_17[0] & 3) << 4);
          local_17[5] = (local_17[2] >> 6) + (char)((local_17[1] & 0xf) << 2);
          for (local_68 = 0; local_68 <= local_6c; local_68 = local_68 + 1) {
            __s[local_64] =
                 "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"
                 [local_17[(long)local_68 + 3]];
            local_64 = local_64 + 1;
          }
          while (local_6c < 3) {
            __s[local_64] = '=';
            local_6c = local_6c + 1;
            local_64 = local_64 + 1;
          }
        }
        __s[local_64] = '\0';
        pFVar4 = fopen("base64_flag.txt","w");
        if (pFVar4 == (FILE *)0x0) {
          perror("Failed to open output file");
          free(local_58 + -__size);
          free(__s);
        }
        else {
          fputs(__s,pFVar4);
          fclose(pFVar4);
          free(local_58 + -__size);
          free(__s);
        }
      }
    }
  }
  if (local_10 == *(long *)(in_FS_OFFSET + 0x28)) {
    return;
  }
                    // WARNING: Subroutine does not return
  __stack_chk_fail();
}



undefined8 login(int param_1)

{
  int iVar1;
  size_t sVar2;
  undefined8 uVar3;
  long in_FS_OFFSET;
  char local_e8 [112];
  char local_78 [104];
  long local_10;
  
  local_10 = *(long *)(in_FS_OFFSET + 0x28);
  write(param_1,"username> ",10);
  read(param_1,local_e8,100);
  write(param_1,"password> ",10);
  read(param_1,local_78,100);
  sVar2 = strcspn(local_e8,"\n");
  local_e8[sVar2] = '\0';
  sVar2 = strcspn(local_78,"\n");
  local_78[sVar2] = '\0';
  iVar1 = strcmp(local_e8,"guest");
  if (iVar1 == 0) {
    iVar1 = strcmp(local_78,"guest");
    if (iVar1 == 0) {
      debug_msg("Success\n");
      uVar3 = 1;
      goto LAB_0010234d;
    }
  }
  debug_msg("Wrong username or password\n");
  uVar3 = 0;
LAB_0010234d:
  if (local_10 != *(long *)(in_FS_OFFSET + 0x28)) {
                    // WARNING: Subroutine does not return
    __stack_chk_fail();
  }
  return uVar3;
}



undefined8 main(void)

{
  int iVar1;
  int iVar2;
  size_t sVar3;
  char *__s1;
  long in_FS_OFFSET;
  int local_8c;
  char local_78 [104];
  long local_10;
  
  local_10 = *(long *)(in_FS_OFFSET + 0x28);
  iVar1 = setup_socket();
  puts("Listening on port 2222...");
  fflush(stdout);
  iVar1 = accept(iVar1,(sockaddr *)0x0,(socklen_t *)0x0);
  if (iVar1 < 0) {
    perror("accept");
                    // WARNING: Subroutine does not return
    exit(1);
  }
  write(iVar1,"Enter commands (type \'exit\' to quit):\n",0x26);
  local_8c = 0;
  while( true ) {
    if (local_8c == 0) {
      write(iVar1,&DAT_001032f2,2);
    }
    else {
      write(iVar1,&DAT_001032ef,2);
    }
    read(iVar1,local_78,100);
    sVar3 = strcspn(local_78,"\n");
    local_78[sVar3] = '\0';
    iVar2 = strcmp(local_78,"exit");
    if (iVar2 == 0) break;
    __s1 = (char *)command_from_string(local_78);
    if (__s1 == (char *)0x0) {
      write(iVar1,"Failed to parse command.\n",0x19);
    }
    else if ((local_8c == 1) && (iVar2 = strcmp(__s1,"get"), iVar2 == 0)) {
      get(__s1,iVar1);
      free_command(__s1);
    }
    else if ((local_8c == 1) && (iVar2 = strcmp(__s1,"put"), iVar2 == 0)) {
      put(__s1,iVar1);
      free_command(__s1);
    }
    else if ((local_8c == 0) && (iVar2 = strcmp(__s1,"login"), iVar2 == 0)) {
      local_8c = login(iVar1);
      free_command(__s1);
    }
    else if (*__s1 != '\0') {
      debug_msg("Unknown method or argument:");
      debug_msg(__s1);
      debug_msg(&DAT_0010327a);
      free_command(__s1);
    }
  }
  if (local_10 == *(long *)(in_FS_OFFSET + 0x28)) {
    return 0;
  }
                    // WARNING: Subroutine does not return
  __stack_chk_fail();
}



void _fini(void)

{
  return;
}



